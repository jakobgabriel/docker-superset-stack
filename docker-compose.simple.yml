version: "3.9"

services:
  superset:
    image: apache/superset:${SUPERSET_TAG:-latest}
    container_name: superset-simple
    environment:
      SUPERSET_SECRET_KEY: ${SUPERSET_SECRET_KEY:-change_me}
      SUPERSET_ENV: production
      SUPERSET_LOAD_EXAMPLES: ${SUPERSET_LOAD_EXAMPLES:-no}
      SQLALCHEMY_DATABASE_URI: sqlite:////app/superset_home/superset.db
      MAPBOX_API_KEY: ${MAPBOX_API_KEY:-}
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_FIRST_NAME: ${ADMIN_FIRST_NAME:-Admin}
      ADMIN_LAST_NAME: ${ADMIN_LAST_NAME:-User}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@superset.local}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin}
    volumes:
      - superset_home:/app/superset_home
    ports:
      - "8088:8088"
    command: >
      bash -lc "set -euo pipefail;
      # Optional extra drivers if present in image path
      if [ -f /app/docker/requirements-local.txt ]; then echo 'Installing extra DB drivers...'; (uv pip install --system --no-cache -r /app/docker/requirements-local.txt || /app/.venv/bin/pip install --no-cache-dir -r /app/docker/requirements-local.txt); fi;
      # Ensure Pillow is available for screenshots/PDF without needing a host bind mount
      /app/.venv/bin/pip install --no-cache-dir pillow;
      /app/.venv/bin/superset db upgrade;
      /app/.venv/bin/superset fab create-admin --username \"${ADMIN_USERNAME}\" --firstname \"${ADMIN_FIRST_NAME}\" --lastname \"${ADMIN_LAST_NAME}\" --email \"${ADMIN_EMAIL}\" --password \"${ADMIN_PASSWORD}\" --exist-ok;
      /app/.venv/bin/superset init;
      exec gunicorn -w ${GUNICORN_WORKERS:-2} -k gevent --timeout ${GUNICORN_TIMEOUT:-120} -b 0.0.0.0:8088 'superset.app:create_app()'"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 15s
      timeout: 5s
      retries: 10
    restart: unless-stopped

volumes:
  superset_home:
